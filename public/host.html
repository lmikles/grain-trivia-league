<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Host Tool â€” Grain Trivia League</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Source+Serif+4:ital,wght@0,300;0,400;0,600;1,300&display=swap" rel="stylesheet" />
  <style>
    :root {
      --cream: #f5f0e8;
      --parchment: #e8dfc8;
      --amber: #c8830a;
      --amber-dark: #9e6508;
      --dark: #1a1410;
      --brown: #3d2b1a;
      --mid: #6b4c2e;
      --light-text: #a08060;
      --border: rgba(200,131,10,0.25);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--dark);
      color: var(--cream);
      font-family: 'Source Serif 4', Georgia, serif;
      min-height: 100vh;
      background-image:
        radial-gradient(ellipse at 20% 20%, rgba(200,131,10,0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(61,43,26,0.6) 0%, transparent 50%);
    }
    .grain-overlay {
      position: fixed; inset: 0; pointer-events: none; z-index: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
      opacity: 0.4;
    }
    .container {
      position: relative; z-index: 1;
      max-width: 600px;
      margin: 0 auto;
      padding: 48px 24px 80px;
    }
    header {
      text-align: center;
      margin-bottom: 36px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }
    .logo-eyebrow {
      font-size: 11px;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: var(--amber);
      margin-bottom: 10px;
    }
    h1 {
      font-family: 'Playfair Display', serif;
      font-size: clamp(1.6rem, 4vw, 2.4rem);
      font-weight: 900;
      color: var(--cream);
    }
    h1 span { color: var(--amber); }
    .subtitle {
      margin-top: 8px;
      font-size: 0.9rem;
      color: var(--light-text);
      font-style: italic;
    }
    .card {
      background: rgba(61,43,26,0.35);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 28px;
      margin-bottom: 20px;
    }
    .card-title {
      font-family: 'Playfair Display', serif;
      font-size: 1rem;
      color: var(--amber);
      margin-bottom: 18px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }
    label {
      display: block;
      font-size: 10px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--amber);
      margin-bottom: 7px;
    }
    input, select {
      width: 100%;
      background: rgba(26,20,16,0.6);
      border: 1px solid var(--border);
      border-radius: 3px;
      color: var(--cream);
      font-family: 'Source Serif 4', serif;
      font-size: 0.9rem;
      padding: 10px 12px;
      appearance: none;
      transition: border-color 0.2s;
    }
    input:focus, select:focus { outline: none; border-color: var(--amber); }
    input[type="number"] { -moz-appearance: textfield; }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { appearance: none; }
    input::placeholder { color: rgba(160,128,96,0.4); }
    select option { background: var(--brown); }
    .field { margin-bottom: 18px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; }
    @media(max-width:480px) {
      .grid-2, .grid-3 { grid-template-columns: 1fr 1fr; }
    }
    /* Round scores */
    .rounds-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 14px;
    }
    .round-field label {
      font-size: 9px;
      color: var(--light-text);
      letter-spacing: 0.15em;
    }
    .round-field input {
      text-align: center;
      padding: 10px 6px;
      font-size: 1.1rem;
      font-family: 'Playfair Display', serif;
    }
    /* Running total */
    .total-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(200,131,10,0.1);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 12px 16px;
      margin-top: 4px;
    }
    .total-label {
      font-size: 10px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--light-text);
    }
    .total-value {
      font-family: 'Playfair Display', serif;
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--amber);
    }
    /* Buttons */
    .btn {
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-family: 'Playfair Display', serif;
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      padding: 13px 24px;
      transition: all 0.2s;
    }
    .btn-primary {
      width: 100%;
      background: var(--amber);
      color: var(--dark);
    }
    .btn-primary:hover { background: #d9910b; transform: translateY(-1px); }
    .btn-primary:active { transform: translateY(0); }
    .btn-primary:disabled { opacity: 0.45; cursor: not-allowed; transform: none; }
    .btn-secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--light-text);
      font-size: 0.85rem;
      padding: 9px 18px;
    }
    .btn-secondary:hover { border-color: var(--amber); color: var(--cream); }
    /* Auth screen */
    #authScreen { display: block; }
    #mainScreen { display: none; }
    .auth-icon {
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 16px;
    }
    /* Submitted scores log */
    .log-title {
      font-size: 10px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--amber);
      margin-bottom: 12px;
    }
    .log-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(200,131,10,0.1);
      font-size: 0.88rem;
    }
    .log-item:last-child { border-bottom: none; }
    .log-team { font-weight: 600; }
    .log-pts {
      font-family: 'Playfair Display', serif;
      font-size: 1rem;
      color: var(--amber);
    }
    .msg {
      margin-top: 14px;
      padding: 12px 16px;
      border-radius: 3px;
      font-size: 0.88rem;
      display: none;
    }
    .msg.error { display:block; background:rgba(192,80,74,0.15); border:1px solid rgba(192,80,74,0.3); color:#e07878; }
    .msg.success { display:block; background:rgba(74,158,107,0.15); border:1px solid rgba(74,158,107,0.3); color:#7ec89a; }
    /* Locked indicator */
    .lock-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--amber);
      border: 1px solid var(--border);
      border-radius: 2px;
      padding: 4px 10px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
<div class="grain-overlay"></div>
<div class="container">

  <header>
    <div class="logo-eyebrow">Grain Craft Bar + Kitchen</div>
    <h1>Host <span>Tool</span></h1>
    <div class="subtitle">Score entry â€” internal use only</div>
  </header>

  <!-- AUTH SCREEN -->
  <div id="authScreen">
    <div class="card">
      <div class="auth-icon">ğŸ”</div>
      <div class="field">
        <label for="secretInput">Host Secret Key</label>
        <input type="password" id="secretInput" placeholder="Enter your host key" />
      </div>
      <button class="btn btn-primary" onclick="unlock()">Unlock</button>
      <div class="msg" id="authMsg"></div>
    </div>
  </div>

  <!-- MAIN SCREEN -->
  <div id="mainScreen">

    <!-- Game night setup -->
    <div class="card">
      <div class="card-title">Tonight's Game</div>
      <div class="grid-3" style="margin-bottom:18px">
        <div class="field" style="margin:0">
          <label for="location">Location</label>
          <select id="location" onchange="loadTeams()">
            <option value="Main Street">Main Street</option>
            <option value="Exchange">Exchange</option>
            <option value="H2O">H2O</option>
          </select>
        </div>
        <div class="field" style="margin:0">
          <label for="week">Week</label>
          <input type="number" id="week" value="1" min="1" max="52" />
        </div>
        <div class="field" style="margin:0">
          <label for="gameDate">Date</label>
          <input type="date" id="gameDate" />
        </div>
      </div>
    </div>

    <!-- Score entry -->
    <div class="card">
      <div class="card-title">Enter Score</div>

      <div class="field">
        <label for="teamSelect">Team</label>
        <select id="teamSelect">
          <option value="">â€” loading teamsâ€¦ â€”</option>
        </select>
      </div>

      <div style="margin-bottom:14px">
        <label>Round Scores (leave blank if round not played)</label>
        <div class="rounds-grid">
          <div class="round-field"><label>Round 1</label><input type="number" id="r1" min="0" oninput="updateTotal()" /></div>
          <div class="round-field"><label>Round 2</label><input type="number" id="r2" min="0" oninput="updateTotal()" /></div>
          <div class="round-field"><label>Round 3</label><input type="number" id="r3" min="0" oninput="updateTotal()" /></div>
          <div class="round-field"><label>Round 4</label><input type="number" id="r4" min="0" oninput="updateTotal()" /></div>
          <div class="round-field"><label>Round 5</label><input type="number" id="r5" min="0" oninput="updateTotal()" /></div>
          <div class="round-field"><label>Round 6</label><input type="number" id="r6" min="0" oninput="updateTotal()" /></div>
        </div>
        <div class="field" style="margin-bottom:12px">
          <label>Lightning / Bonus Round</label>
          <input type="number" id="bonus" min="0" placeholder="0" oninput="updateTotal()" />
        </div>
        <div class="total-bar">
          <span class="total-label">Total Score</span>
          <span class="total-value" id="totalDisplay">0</span>
        </div>
      </div>

      <div class="field">
        <label for="submittedBy">Your Name (host)</label>
        <input type="text" id="submittedBy" placeholder="Host name" />
      </div>

      <button class="btn btn-primary" id="submitBtn" onclick="submitScore()">Submit Score</button>
      <div class="msg" id="scoreMsg"></div>
    </div>

    <!-- Submitted tonight -->
    <div class="card" id="logCard" style="display:none">
      <div class="log-title">Submitted Tonight</div>
      <div id="scoreLog"></div>
    </div>

  </div><!-- /mainScreen -->
</div>

<script>
let hostSecret = '';
let submittedScores = [];

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function unlock() {
  const val = document.getElementById('secretInput').value.trim();
  const msg = document.getElementById('authMsg');
  if (!val) {
    msg.className = 'msg error';
    msg.textContent = 'Please enter the host key.';
    return;
  }
  hostSecret = val;
  // Quick test against /api/setup OPTIONS (just verify the key works)
  verifyKey();
}

async function verifyKey() {
  const msg = document.getElementById('authMsg');
  msg.className = 'msg';
  msg.textContent = '';
  try {
    // Use teams endpoint as a lightweight check â€” then try a setup call
    const res = await fetch('/api/teams');
    if (res.ok) {
      showMainScreen();
    } else {
      throw new Error('Could not reach server');
    }
  } catch(e) {
    msg.className = 'msg error';
    msg.textContent = 'Could not connect. Check your network and try again.';
  }
}

function showMainScreen() {
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('mainScreen').style.display = 'block';
  // Set today's date
  document.getElementById('gameDate').value = new Date().toISOString().slice(0, 10);
  loadTeams();
}

// â”€â”€ Teams dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTeams() {
  const location = document.getElementById('location').value;
  const sel = document.getElementById('teamSelect');
  sel.innerHTML = '<option value="">Loadingâ€¦</option>';
  try {
    const res = await fetch(`/api/teams?location=${encodeURIComponent(location)}`);
    const data = await res.json();
    if (!data.teams.length) {
      sel.innerHTML = '<option value="">No teams registered yet</option>';
    } else {
      sel.innerHTML = '<option value="">â€” select a team â€”</option>' +
        data.teams.map(t => `<option value="${escAttr(t.teamId)}" data-name="${escAttr(t.teamName)}">${escHtml(t.teamName)}</option>`).join('');
    }
  } catch(e) {
    sel.innerHTML = '<option value="">Error loading teams</option>';
  }
}

// â”€â”€ Score calculation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateTotal() {
  const ids = ['r1','r2','r3','r4','r5','r6','bonus'];
  const total = ids.reduce((sum, id) => {
    const v = parseFloat(document.getElementById(id).value);
    return sum + (isNaN(v) ? 0 : v);
  }, 0);
  document.getElementById('totalDisplay').textContent = total % 1 === 0 ? total : total.toFixed(1);
}

// â”€â”€ Submit score â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function submitScore() {
  const sel      = document.getElementById('teamSelect');
  const teamId   = sel.value;
  const teamName = sel.options[sel.selectedIndex]?.dataset.name || '';
  const location = document.getElementById('location').value;
  const week     = document.getElementById('week').value;
  const date     = document.getElementById('gameDate').value;
  const submittedBy = document.getElementById('submittedBy').value.trim();
  const msg      = document.getElementById('scoreMsg');
  const btn      = document.getElementById('submitBtn');

  msg.className = 'msg';
  msg.textContent = '';

  if (!teamId) { showMsg('scoreMsg', 'error', 'Please select a team.'); return; }
  if (!date)   { showMsg('scoreMsg', 'error', 'Please enter a date.');   return; }

  const roundIds = ['r1','r2','r3','r4','r5','r6'];
  const rounds = roundIds
    .map(id => document.getElementById(id).value)
    .filter(v => v !== '')
    .map(Number);

  const bonus = parseFloat(document.getElementById('bonus').value) || 0;
  const total = rounds.reduce((s,v)=>s+v,0) + bonus;

  btn.disabled = true;
  btn.textContent = 'Submittingâ€¦';

  try {
    const res = await fetch('/api/scores', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${hostSecret}`,
      },
      body: JSON.stringify({ teamId, teamName, location, week, date, rounds, bonusRound: bonus, submittedBy }),
    });
    const data = await res.json();

    if (!res.ok) {
      if (res.status === 401) {
        showMsg('scoreMsg', 'error', 'Invalid host key â€” please refresh and re-enter it.');
      } else {
        throw new Error(data.error || 'Submission failed');
      }
      return;
    }

    // Add to log
    submittedScores.unshift({ teamName, total, location, week });
    renderLog();
    clearScoreForm();
    showMsg('scoreMsg', 'success', `âœ“ ${teamName} â€” ${total} points recorded.`);

  } catch(err) {
    showMsg('scoreMsg', 'error', err.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'Submit Score';
  }
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showMsg(id, type, text) {
  const el = document.getElementById(id);
  el.className = `msg ${type}`;
  el.textContent = text;
}

function clearScoreForm() {
  ['r1','r2','r3','r4','r5','r6','bonus'].forEach(id => {
    document.getElementById(id).value = '';
  });
  document.getElementById('teamSelect').value = '';
  document.getElementById('totalDisplay').textContent = '0';
}

function renderLog() {
  const card = document.getElementById('logCard');
  const log  = document.getElementById('scoreLog');
  if (!submittedScores.length) { card.style.display='none'; return; }
  card.style.display = 'block';
  log.innerHTML = submittedScores.map(s => `
    <div class="log-item">
      <div>
        <div class="log-team">${escHtml(s.teamName)}</div>
        <div style="font-size:0.78rem;color:var(--light-text)">${escHtml(s.location)} Â· Week ${s.week}</div>
      </div>
      <div class="log-pts">${s.total}</div>
    </div>`).join('');
}

function escHtml(s) {
  return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function escAttr(s) { return escHtml(s); }

// Submit on Enter in secret field
document.getElementById('secretInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') unlock();
});
</script>
</body>
</html>
