<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Standings â€” Grain Trivia League</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Source+Serif+4:ital,wght@0,300;0,400;0,600;1,300&display=swap" rel="stylesheet" />
  <style>
    :root {
      --cream: #f5f0e8;
      --parchment: #e8dfc8;
      --amber: #c8830a;
      --amber-dark: #9e6508;
      --dark: #1a1410;
      --brown: #3d2b1a;
      --mid: #6b4c2e;
      --light-text: #a08060;
      --border: rgba(200,131,10,0.25);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--dark);
      color: var(--cream);
      font-family: 'Source Serif 4', Georgia, serif;
      min-height: 100vh;
      background-image:
        radial-gradient(ellipse at 20% 20%, rgba(200,131,10,0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(61,43,26,0.6) 0%, transparent 50%);
    }
    .grain-overlay {
      position: fixed; inset: 0; pointer-events: none; z-index: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
      opacity: 0.4;
    }
    .container {
      position: relative; z-index: 1;
      max-width: 820px;
      margin: 0 auto;
      padding: 48px 24px 80px;
    }
    header {
      text-align: center;
      margin-bottom: 36px;
      padding-bottom: 28px;
      border-bottom: 1px solid var(--border);
    }
    .logo-eyebrow {
      font-size: 11px;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: var(--amber);
      margin-bottom: 12px;
    }
    h1 {
      font-family: 'Playfair Display', serif;
      font-size: clamp(1.8rem, 4vw, 2.8rem);
      font-weight: 900;
      color: var(--cream);
    }
    h1 span { color: var(--amber); }
    .subtitle {
      margin-top: 8px;
      font-size: 0.95rem;
      color: var(--light-text);
      font-style: italic;
      font-weight: 300;
    }
    /* Location filter tabs */
    .filter-bar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 28px;
    }
    .filter-btn {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 2px;
      color: var(--light-text);
      cursor: pointer;
      font-family: 'Source Serif 4', serif;
      font-size: 0.85rem;
      padding: 8px 20px;
      transition: all 0.15s;
    }
    .filter-btn:hover { border-color: var(--amber); color: var(--cream); }
    .filter-btn.active {
      background: var(--amber);
      border-color: var(--amber);
      color: var(--dark);
    }
    /* Meta row */
    .meta-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }
    .meta-count {
      font-size: 0.8rem;
      color: var(--light-text);
      font-style: italic;
    }
    .refresh-btn {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 2px;
      color: var(--light-text);
      cursor: pointer;
      font-family: 'Source Serif 4', serif;
      font-size: 0.78rem;
      padding: 5px 12px;
      transition: all 0.15s;
    }
    .refresh-btn:hover { border-color: var(--amber); color: var(--amber); }
    /* Table */
    .table-wrap {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    thead tr {
      border-bottom: 1px solid var(--border);
    }
    th {
      font-size: 9px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--amber);
      font-weight: 600;
      padding: 10px 14px;
      text-align: left;
      white-space: nowrap;
    }
    th.num { text-align: right; }
    td {
      padding: 14px 14px;
      font-size: 0.9rem;
      border-bottom: 1px solid rgba(200,131,10,0.08);
      vertical-align: middle;
    }
    td.num { text-align: right; color: var(--light-text); }
    tr:last-child td { border-bottom: none; }
    tbody tr { transition: background 0.1s; }
    tbody tr:hover { background: rgba(200,131,10,0.04); }
    /* Top 3 rows */
    tbody tr.rank-1 td.rank-cell { color: #ffd700; font-size: 1.1rem; }
    tbody tr.rank-2 td.rank-cell { color: #c0c0c0; font-size: 1.05rem; }
    tbody tr.rank-3 td.rank-cell { color: #cd7f32; }
    .rank-cell { font-family: 'Playfair Display', serif; font-weight: 700; }
    .team-name-cell { font-weight: 600; color: var(--cream); }
    .location-badge {
      display: inline-block;
      font-size: 10px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--light-text);
      border: 1px solid rgba(200,131,10,0.2);
      border-radius: 2px;
      padding: 2px 7px;
    }
    .points-cell {
      font-family: 'Playfair Display', serif;
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--amber);
      text-align: right;
    }
    /* Empty / loading states */
    .state-msg {
      text-align: center;
      padding: 48px 24px;
      color: var(--light-text);
      font-style: italic;
    }
    .loading-dots span { animation: blink 1.2s infinite; }
    .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink { 0%,80%,100%{opacity:0.2}40%{opacity:1} }
    /* Footer */
    .footer-meta {
      margin-top: 28px;
      text-align: center;
      font-size: 0.78rem;
      color: var(--light-text);
      font-style: italic;
    }
    .nav-links {
      display: flex;
      gap: 24px;
      justify-content: center;
      margin-top: 32px;
    }
    .nav-links a {
      color: var(--amber);
      text-decoration: none;
      font-size: 0.85rem;
      border-bottom: 1px solid transparent;
      transition: border-color 0.15s;
    }
    .nav-links a:hover { border-bottom-color: var(--amber); }
  </style>
</head>
<body>
<div class="grain-overlay"></div>
<div class="container">

  <header>
    <div class="logo-eyebrow">Grain Craft Bar + Kitchen</div>
    <h1>Season <span>Standings</span></h1>
    <div class="subtitle">Trivia League â€” Current Rankings</div>
  </header>

  <div class="filter-bar">
    <button class="filter-btn active" data-location="">All Locations</button>
    <button class="filter-btn" data-location="Main Street">Main Street</button>
    <button class="filter-btn" data-location="Exchange">Exchange</button>
    <button class="filter-btn" data-location="H2O">H2O</button>
  </div>

  <div class="meta-row">
    <div class="meta-count" id="metaCount"></div>
    <button class="refresh-btn" onclick="loadStandings()">â†º Refresh</button>
  </div>

  <div class="table-wrap">
    <div id="tableContainer">
      <div class="state-msg">
        Loading standings<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>
      </div>
    </div>
  </div>

  <div class="footer-meta" id="footerMeta"></div>

  <div class="nav-links">
    <a href="/register.html">Register a Team</a>
    <a href="/">Host Tools</a>
  </div>

</div>

<script>
let currentLocation = '';
let refreshTimer;

const RANK_EMOJI = { 1: 'ðŸ¥‡', 2: 'ðŸ¥ˆ', 3: 'ðŸ¥‰' };

document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentLocation = btn.dataset.location;
    loadStandings();
  });
});

async function loadStandings() {
  const container = document.getElementById('tableContainer');
  container.innerHTML = '<div class="state-msg">Loading standings<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span></div>';
  document.getElementById('metaCount').textContent = '';

  try {
    const url = '/api/standings' + (currentLocation ? `?location=${encodeURIComponent(currentLocation)}` : '');
    const res = await fetch(url);
    const data = await res.json();

    if (!res.ok) throw new Error(data.error || 'Failed to load');

    const { standings, lastUpdated } = data;

    if (!standings.length) {
      container.innerHTML = '<div class="state-msg">No scores recorded yet â€” check back after game night!</div>';
      document.getElementById('metaCount').textContent = '';
      document.getElementById('footerMeta').textContent = '';
      return;
    }

    const locLabel = currentLocation || 'All Locations';
    document.getElementById('metaCount').textContent =
      `${standings.length} team${standings.length !== 1 ? 's' : ''} Â· ${locLabel}`;

    document.getElementById('footerMeta').textContent =
      `Updated ${new Date(lastUpdated).toLocaleString('en-US', { month:'short', day:'numeric', hour:'numeric', minute:'2-digit' })}`;

    const rows = standings.map(s => {
      const rankDisplay = RANK_EMOJI[s.rank] || `#${s.rank}`;
      return `
        <tr class="rank-${s.rank}">
          <td class="rank-cell">${rankDisplay}</td>
          <td class="team-name-cell">${escHtml(s.teamName)}</td>
          <td><span class="location-badge">${escHtml(s.location)}</span></td>
          <td class="num">${s.gamesPlayed}</td>
          <td class="points-cell">${s.totalPoints.toLocaleString()}</td>
          <td class="num">${s.averageScore.toFixed(1)}</td>
          <td class="num">${s.bestScore.toLocaleString()}</td>
        </tr>`;
    }).join('');

    container.innerHTML = `
      <table>
        <thead>
          <tr>
            <th style="width:48px">Rank</th>
            <th>Team</th>
            <th>Location</th>
            <th class="num">Played</th>
            <th class="num">Total Pts</th>
            <th class="num">Avg</th>
            <th class="num">Best</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`;

  } catch (err) {
    container.innerHTML = `<div class="state-msg">Couldn't load standings: ${escHtml(err.message)}</div>`;
  }
}

function escHtml(str) {
  return String(str ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// Auto-refresh every 60 seconds
function scheduleRefresh() {
  clearTimeout(refreshTimer);
  refreshTimer = setTimeout(() => { loadStandings(); scheduleRefresh(); }, 60000);
}

loadStandings();
scheduleRefresh();
</script>
</body>
</html>
